{{define "content"}}
<header class="card p-4 vstack gap-2">
  <h4>Team Dev Log</h4>
  <p class="text-light status" id="status">Ready</p>
</header>

<section class="card p-4 vstack gap-2">
  <h6>Auth</h6>
  <label for="token">Token</label>
  <input id="token" placeholder="PUDXXXXXXXXX" />
  <menu class="buttons mt-2">
    <button id="saveToken" data-variant="secondary" class="outline">Save Token</button>
  </menu>
</section>

<section class="card p-4 vstack gap-2">
  <h6>Write Entry</h6>
  <label for="content">Content</label>
  <textarea id="content" placeholder="what changed, what broke, what shipped"></textarea>
  <menu class="buttons mt-2">
    <button id="postEntry">Post Entry</button>
  </menu>
</section>

<section class="card p-4 vstack gap-2">
  <h6>Entries</h6>
  <label for="day">Day</label>
  <div class="hstack">
    <input id="day" type="date" />
    <button id="loadEntries" data-variant="secondary" class="outline">Load</button>
  </div>
  <div id="entries" class="vstack gap-2 mt-2"></div>
  <p class="text-light">For a read-only screen use <a href="/entries-view">/entries-view</a>.</p>
</section>
{{end}}

{{define "scripts"}}
<script>
  const api = 'http://localhost:9173';
  const tokenEl = document.getElementById('token');
  const statusEl = document.getElementById('status');
  const entriesEl = document.getElementById('entries');
  const dayEl = document.getElementById('day');
  dayEl.value = new Date().toISOString().slice(0, 10);

  const saved = localStorage.getItem('devlog_token') || '';
  tokenEl.value = saved;

  function setStatus(v){ statusEl.textContent = v; }
  function getToken(){ return (tokenEl.value || '').trim().toUpperCase(); }

  function headers() {
    return {
      'Content-Type': 'application/json',
      'Authorization': 'Bearer ' + getToken()
    };
  }

  document.getElementById('saveToken').onclick = () => {
    const tok = getToken();
    localStorage.setItem('devlog_token', tok);
    tokenEl.value = tok;
    setStatus('Token saved in localStorage');
    if (window.ot && window.ot.toast) window.ot.toast('Token saved', 'Auth', { variant: 'success' });
  };

  document.getElementById('postEntry').onclick = async () => {
    try {
      const content = document.getElementById('content').value.trim();
      if (!content) { setStatus('Content is required'); return; }
      const res = await fetch(api + '/api/entries', { method:'POST', headers: headers(), body: JSON.stringify({content}) });
      const body = await res.json();
      if (!res.ok) throw new Error(body.error || 'request failed');
      document.getElementById('content').value = '';
      setStatus('Entry posted');
      if (window.ot && window.ot.toast) window.ot.toast('Entry posted', 'Success', { variant: 'success' });
    } catch (e) {
      setStatus('Post failed: ' + e.message);
      if (window.ot && window.ot.toast) window.ot.toast(e.message, 'Post failed', { variant: 'danger' });
    }
  };

  document.getElementById('loadEntries').onclick = loadEntries;

  async function loadEntries() {
    try {
      const day = dayEl.value;
      const res = await fetch(api + '/api/entries?day=' + encodeURIComponent(day), { headers: headers() });
      const body = await res.json();
      if (!res.ok) throw new Error(body.error || 'request failed');
      renderEntries(body.entries || []);
      setStatus('Loaded ' + (body.entries || []).length + ' entries');
    } catch (e) {
      entriesEl.innerHTML = '';
      setStatus('Load failed: ' + e.message);
    }
  }

  function esc(s) {
    return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[c]));
  }

  function renderEntries(entries) {
    if (!entries.length) {
      entriesEl.innerHTML = '<article class="card p-3"><p class="text-light">No entries</p></article>';
      return;
    }
    entriesEl.innerHTML = entries.map(e => {
      return '<article class="card p-3">'
        + '<p class="text-light">[' + esc(e.entry_type) + '] ' + esc(e.user) + ' @ ' + esc(e.created_at) + '</p>'
        + '<p>' + esc(e.content) + '</p>'
        + '</article>';
    }).join('');
  }
</script>
{{end}}
