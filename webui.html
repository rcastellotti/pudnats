<!doctype html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PUD Dev Log</title>
  <link rel="stylesheet" href="/assets/oat.min.css" />
  <script defer src="/assets/oat.min.js"></script>
  <style>
    :root {
      --primary: #57b3ff;
      --ring: #57b3ff;
      --background: #0b0d10;
      --card: #11161c;
      --muted: #161d26;
      --border: #263344;
      --font-mono: "IBM Plex Mono", "SFMono-Regular", Menlo, Consolas, monospace;
      --font-sans: "IBM Plex Mono", "SFMono-Regular", Menlo, Consolas, monospace;
    }
    body {
      background:
        radial-gradient(880px 360px at 95% -10%, color-mix(in srgb, var(--primary), transparent 80%), transparent 65%),
        var(--background);
    }
    main { max-width: 920px; margin: 0 auto; padding: var(--space-6) var(--space-4); }
    header pre { margin: 0; }
    .status { min-height: 1.2em; }
  </style>
</head>
<body>
  <main class="vstack gap-4">
    <header class="card p-4">
      <pre>┌──────────────────────────────────────────────────────────┐
│ PUD TEAM DEV LOG                                        │
│ /local/storage/notes                                     │
└──────────────────────────────────────────────────────────┘</pre>
      <p class="text-light mt-2 status" id="status">Ready</p>
    </header>

    <section class="card p-4">
      <h6>AUTH TOKEN</h6>
      <label for="token">Token</label>
      <input id="token" placeholder="PUDXXXXXXXXX" />
      <menu class="buttons mt-2">
        <button id="saveToken" data-variant="secondary" class="outline">Save Token</button>
      </menu>
    </section>

    <section class="card p-4">
      <h6>WRITE ENTRY</h6>
      <label for="content">Content</label>
      <textarea id="content" placeholder="what changed, what broke, what shipped"></textarea>
      <menu class="buttons mt-2">
        <button id="postEntry">Post Entry</button>
      </menu>
    </section>

    <section class="card p-4">
      <h6>QUERY ENTRIES</h6>
      <label for="day">Day</label>
      <div class="hstack">
        <input id="day" type="date" />
        <button id="loadEntries" data-variant="secondary" class="outline">Load</button>
      </div>
      <div id="entries" class="mt-4"></div>
    </section>
  </main>

  <script>
    const api = 'http://localhost:9173';
    const tokenEl = document.getElementById('token');
    const statusEl = document.getElementById('status');
    const entriesEl = document.getElementById('entries');
    const dayEl = document.getElementById('day');
    dayEl.value = new Date().toISOString().slice(0, 10);

    const saved = localStorage.getItem('devlog_token') || '';
    tokenEl.value = saved;

    function setStatus(v){ statusEl.textContent = v; }
    function getToken(){ return (tokenEl.value || '').trim().toUpperCase(); }

    function headers() {
      return {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer ' + getToken()
      };
    }

    document.getElementById('saveToken').onclick = () => {
      const tok = getToken();
      localStorage.setItem('devlog_token', tok);
      tokenEl.value = tok;
      setStatus('Token saved in localStorage');
      if (window.ot && window.ot.toast) window.ot.toast('Token saved', 'Auth', { variant: 'success' });
    };

    document.getElementById('postEntry').onclick = async () => {
      try {
        const content = document.getElementById('content').value.trim();
        if (!content) { setStatus('Content is required'); return; }
        const res = await fetch(api + '/api/entries', { method:'POST', headers: headers(), body: JSON.stringify({content}) });
        const body = await res.json();
        if (!res.ok) throw new Error(body.error || 'request failed');
        document.getElementById('content').value = '';
        setStatus('Entry posted');
        if (window.ot && window.ot.toast) window.ot.toast('Entry posted', 'Success', { variant: 'success' });
      } catch (e) {
        setStatus('Post failed: ' + e.message);
        if (window.ot && window.ot.toast) window.ot.toast(e.message, 'Post failed', { variant: 'danger' });
      }
    };

    document.getElementById('loadEntries').onclick = loadEntries;

    async function loadEntries() {
      try {
        const day = dayEl.value;
        const res = await fetch(api + '/api/entries?day=' + encodeURIComponent(day), { headers: headers() });
        const body = await res.json();
        if (!res.ok) throw new Error(body.error || 'request failed');
        renderEntries(body.entries || []);
        setStatus('Loaded ' + (body.entries || []).length + ' entries');
      } catch (e) {
        entriesEl.innerHTML = '';
        setStatus('Load failed: ' + e.message);
      }
    }

    function esc(s) {
      return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[c]));
    }

    function renderEntries(entries) {
      if (!entries.length) {
        entriesEl.innerHTML = '<article class="card p-4"><p class="text-light">No entries</p></article>';
        return;
      }
      entriesEl.innerHTML = entries.map(e => {
        return '<article class="card p-4 mb-2">'
          + '<p class="text-light">[' + esc(e.entry_type) + '] ' + esc(e.user) + ' @ ' + esc(e.created_at) + '</p>'
          + '<p>' + esc(e.content) + '</p>'
          + '</article>';
      }).join('');
    }
  </script>
</body>
</html>
