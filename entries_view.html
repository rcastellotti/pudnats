<!doctype html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PUD Entries View</title>
  <link rel="stylesheet" href="/assets/oat.min.css" />
  <script defer src="/assets/oat.min.js"></script>
  <style>
    :root {
      --primary: #57b3ff;
      --ring: #57b3ff;
      --background: #0b0d10;
      --card: #11161c;
      --muted: #161d26;
      --border: #263344;
      --font-mono: "IBM Plex Mono", "SFMono-Regular", Menlo, Consolas, monospace;
      --font-sans: "IBM Plex Mono", "SFMono-Regular", Menlo, Consolas, monospace;
    }
    body {
      background:
        radial-gradient(880px 360px at 95% -10%, color-mix(in srgb, var(--primary), transparent 80%), transparent 65%),
        var(--background);
    }
    main { max-width: 920px; margin: 0 auto; padding: var(--space-6) var(--space-4); }
    .status { min-height: 1.2em; }
  </style>
</head>
<body>
  <main class="vstack gap-4">
    <header class="card p-4">
      <h4>PUD ENTRIES VIEW</h4>
      <p class="text-light" id="dayMeta"></p>
      <p class="text-light status" id="status">Loading...</p>
    </header>

    <section id="entries" class="vstack gap-2"></section>

    <p class="text-light">Open full UI at <a href="/">/</a></p>
  </main>

  <script>
    const api = 'http://localhost:9173';
    const statusEl = document.getElementById('status');
    const dayMetaEl = document.getElementById('dayMeta');
    const entriesEl = document.getElementById('entries');

    function setStatus(v){ statusEl.textContent = v; }
    function esc(s) {
      return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[c]));
    }

    function today() {
      return new Date().toISOString().slice(0, 10);
    }

    function getParam(name) {
      const p = new URLSearchParams(window.location.search);
      return (p.get(name) || '').trim();
    }

    function getDay() {
      const d = getParam('day');
      return /^\d{4}-\d{2}-\d{2}$/.test(d) ? d : today();
    }

    function getToken() {
      const fromQuery = getParam('token').toUpperCase();
      if (fromQuery) {
        localStorage.setItem('devlog_token', fromQuery);
        return fromQuery;
      }
      return (localStorage.getItem('devlog_token') || '').trim().toUpperCase();
    }

    function headers() {
      return {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer ' + getToken()
      };
    }

    function renderEntries(entries) {
      if (!entries.length) {
        entriesEl.innerHTML = '<article class="card p-4"><p class="text-light">No entries</p></article>';
        return;
      }
      entriesEl.innerHTML = entries.map(e => {
        return '<article class="card p-4">'
          + '<p class="text-light">[' + esc(e.entry_type) + '] ' + esc(e.user) + ' @ ' + esc(e.created_at) + '</p>'
          + '<p>' + esc(e.content) + '</p>'
          + '</article>';
      }).join('');
    }

    async function loadEntries() {
      const day = getDay();
      dayMetaEl.textContent = 'day=' + day;

      const token = getToken();
      if (!token) {
        setStatus('No token found. Use / then save token, or pass ?token=PUD...');
        entriesEl.innerHTML = '';
        return;
      }

      try {
        const res = await fetch(api + '/api/entries?day=' + encodeURIComponent(day), { headers: headers() });
        const body = await res.json();
        if (!res.ok) throw new Error(body.error || 'request failed');
        renderEntries(body.entries || []);
        setStatus('Loaded ' + (body.entries || []).length + ' entries');
      } catch (e) {
        entriesEl.innerHTML = '';
        setStatus('Load failed: ' + e.message);
      }
    }

    loadEntries();
  </script>
</body>
</html>
